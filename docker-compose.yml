services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-api_db}
      MYSQL_USER: ${MYSQL_USER:-api_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-api_pass}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_pass}
    ports: ["3306:3306"]
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u$${MYSQL_USER} -p$${MYSQL_PASSWORD} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7
    ports: ["6379:6379"]

  web:
    build: .
    env_file: .env
    environment:
      RUN_MIGRATIONS: "1"
      CREATE_SUPERUSER: "1"
      WAIT_FOR_MIGRATIONS: "0"
      # IA local via Ollama
      AI_PROVIDER: ${AI_PROVIDER:-ollama}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-phi3:mini}
    volumes:
      - .:/app
      - media_data:/app/media
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    ports: ["8000:8000"]
    # En Linux, habilita acceso al host con:
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"

  worker:
    build: .
    env_file: .env
    environment:
      RUN_MIGRATIONS: "0"
      CREATE_SUPERUSER: "0"
      WAIT_FOR_MIGRATIONS: "1"
      # IA local via Ollama
      AI_PROVIDER: ${AI_PROVIDER:-ollama}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-phi3:mini}
    command: celery -A api_backend worker -l INFO -Q celery -c 1
    volumes:
      - media_data:/app/media
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    # En Linux, habilita acceso al host con:
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"

  beat:
    build: .
    env_file: .env
    environment:
      RUN_MIGRATIONS: "0"
      CREATE_SUPERUSER: "0"
      WAIT_FOR_MIGRATIONS: "1"
    command: celery -A api_backend beat -l INFO
    volumes:
      - media_data:/app/media
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started

volumes:
  mysql_data:
  media_data:
